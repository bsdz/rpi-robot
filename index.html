<!DOCTYPE html>
<html>
<head>
  <title>RPiBot Control</title>  
  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
</head>
<body>

<style>
input.button {
    height: 100px; 
    width: 100px;
    position: absolute; 
}
input.autoPilotbutton {
    height: 50px; 
    width: 50px;
}
#logPanel {
    width:320px;
    height:240px;
    overflow:auto;
    border:1px solid #000000;
    font-family:"Courier New", Courier, monospace;
    font-size:10px
}
.statusHeader {
    font-family:"Courier New", Courier, monospace;
    font-size:10px;
    font-weight: bold
}
.statusData {
    font-family:"Courier New", Courier, monospace;
    font-size:10px;
}
</style>

<table style="">
<tr>
    <td>
        <canvas id="videoCanvas" width="320" height="240" style="border:1px solid #000000;"></canvas>
    </td>
    <td>
        <div id='logPanel'></div>
    </td>
    <td style="vertical-align:text-top;">
        <table>
            <tr><td class="statusHeader">CPU Temp</td><td class="statusData"><div id="cpuTemp"/></td></tr>
            <tr><td class="statusHeader">GPU Temp</td><td class="statusData"><div id="gpuTemp"/></td></tr>
            <tr><td class="statusHeader">CPU Load</td><td class="statusData"><div id="cpuLoad"/></td></tr>
            <tr><td class="statusHeader">Core Volt</td><td class="statusData"><div id="coreVolt"/></td></tr>
            <tr><td class="statusHeader">M1 Speed</td><td class="statusData"><div id="m1Speed"/></td></tr>
            <tr><td class="statusHeader">M2 Speed</td><td class="statusData"><div id="m2Speed"/></td></tr>
            <tr><td class="statusHeader">Servo 1</td><td class="statusData"><div id="servo1"/></td></tr>
            <tr><td class="statusHeader">Servo 2</td><td class="statusData"><div id="servo2"/></td></tr>
        </table>
        <input class="autoPilotButton" style="" type="button" value="AP On" onclick="commandRelayWorker.postMessage({'command':'autopiloton'});" />
        <input class="autoPilotButton" style="" type="button" value="AP Off" onclick="commandRelayWorker.postMessage({'command':'autopilotoff'});" />
    </td>
</tr>
</table>

<input class="button" style="left: 150px; top: 300px" type="button" value="Forward (&uarr;)" onclick="commandRelayWorker.postMessage({'command':'forward'});" />
<input class="button" style="left: 050px; top: 400px" type="button" value="Turn Left (&larr;)" onclick="commandRelayWorker.postMessage({'command':'turnleft'});" />
<input class="button" style="left: 150px; top: 400px" type="button" value="Stop (shift)" onclick="commandRelayWorker.postMessage({'command':'brake'});" />
<input class="button" style="left: 250px; top: 400px" type="button" value="Turn Right (&rarr;)" onclick="commandRelayWorker.postMessage({'command':'turnright'});" />
<input class="button" style="left: 150px; top: 500px" type="button" value="Backward (&darr;)" onclick="commandRelayWorker.postMessage({'command':'backward'});" />

<input class="button" style="left: 550px; top: 300px" type="button" value="Tilt up (w)" onclick="commandRelayWorker.postMessage({'command':'tiltup'});" />
<input class="button" style="left: 450px; top: 400px" type="button" value="Pan Left (a)" onclick="commandRelayWorker.postMessage({'command':'panleft'});" />
<input class="button" style="left: 550px; top: 400px" type="button" value="Center (s)" onclick="commandRelayWorker.postMessage({'command':'center'});" />
<input class="button" style="left: 650px; top: 400px" type="button" value="Pan Right (d)" onclick="commandRelayWorker.postMessage({'command':'panright'});" />
<input class="button" style="left: 550px; top: 500px" type="button" value="Tilt down (x)" onclick="commandRelayWorker.postMessage({'command':'tiltdown'});" />

<!--
<img id="opencv-view" src="" width="320" height="240" />
<script type="text/javascript">
window.setInterval(function()
{
    document.getElementById('opencv-view').src = "opencv-out.jpg?random=" + (new Date()).getTime();
}, 5000);
</script>
-->

<script type="text/javascript">
    var keyboardShortcuts = {
        16: "brake",
        17: "brake",
        37: "left",
        38: "forward",
        39: "right",
        40: "backward",
        83: "center",
        65: "panleft",
        87: "tiltup",
        68: "panright",
        88: "tiltdown"
    }
</script>

<script type="text/javascript" src="jsmpg.js"></script>

<script type='text/worker' id='worker-script'>
    var hostname = (new URL(decodeURIComponent(location.pathname))).hostname;
    //var host =  "ws://192.168.0.6:9093/ws"; // for normal operation
    //var host =  "ws://127.0.0.1:9093/ws"; // for tunnelling
    var host =  "ws://" + hostname + ":9093/ws";
    var socket = new WebSocket(host);

    if (socket) {
        socket.onopen = function() {
            postMessage({"log": "Web service: socket open to host: " + host});

            self.addEventListener('message', function(e) { 
                var messageData = e.data;
                if (typeof(messageData) == "string") {
                    messageData = JSON.parse(e.data);
                }
                if ("command" in messageData) {
                    var command = messageData["command"];
                    socket.send(command);
                    postMessage({"log": "processed message: " + command}); 
                }
            },false);
        }

        socket.onmessage = function(msg) {
            postMessage(msg.data);
        }

        socket.onclose = function() {
            postMessage({"log": "Web service: The connection has been closed."});
        }
    }
    else {
        postMessage({"log": "Web service: Failed to create socket."});
    }
</script>

<script>
    function logInfo(txt) {
        document.getElementById('logPanel').innerHTML += txt + '<br />';
    }

    jQuery(function ($) {
        if (!("WebSocket" in window)) {
            logInfo("Your browser does not support web sockets");
        }
    });

    var videoCanvas = document.getElementById('videoCanvas');
    var vcContext = videoCanvas.getContext('2d');
    vcContext.fillStyle = '#444';
    vcContext.fillText('Connecting..', videoCanvas.width / 2 - 30, videoCanvas.height / 3);
    var hostname = (new URL(location.origin)).hostname;
    //var host =  "ws://192.168.0.6:8084/ws"; // for normal operation
    //var host =  "ws://127.0.0.1:8084/ws"; // for tunnelling
    var host =  "ws://" + hostname + ":8084/ws";
    var socket = new WebSocket(host);
    var player = new jsmpeg(socket, { canvas: videoCanvas });

    function updateStatus(statusMessage) {
        for (var key in statusMessage) {
            var e = document.getElementById(key);
            if (e != null) {
                e.innerHTML = statusMessage[key];
            }   
        }
    }

    function makeWorker(script) {
        var URL = window.URL || window.webkitURL;
        var Blob = window.Blob;
        var Worker = window.Worker;

        if (!URL || !Blob || !Worker || !script) {
            return null;
        }

        return new Worker(URL.createObjectURL(new Blob([script])));
    }

    var commandRelayWorker = makeWorker(
        document.getElementById('worker-script').textContent
    );

    commandRelayWorker.onmessage = function (e) {
        var messageData = e.data;
        if (typeof(messageData) == "string") {
            messageData = JSON.parse(e.data);
        }
        if ("log" in messageData) {
            logInfo(messageData["log"]);
        }
        if ("status" in messageData) {
            updateStatus(messageData["status"]);
        }
    };

    document.onkeyup = function () {
        var keyId = event.keyCode;
        if (keyId in keyboardShortcuts) {
            commandRelayWorker.postMessage({"command": keyboardShortcuts[keyId]});
        }
    }
</script>
</body>
</html>
